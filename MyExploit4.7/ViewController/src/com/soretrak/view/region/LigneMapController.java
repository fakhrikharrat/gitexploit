package com.soretrak.view.region;

import javax.faces.context.FacesContext;

import oracle.adf.model.BindingContext;
import oracle.adf.model.RegionBinding;
import oracle.adf.model.RegionContext;
import oracle.adf.model.RegionController;
import oracle.adf.model.binding.DCBindingContainer;

import oracle.binding.AttributeBinding;
import oracle.binding.BindingContainer;

import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;

import org.apache.myfaces.trinidad.render.ExtendedRenderKitService;
import org.apache.myfaces.trinidad.util.Service;

public class LigneMapController implements RegionController {
    public LigneMapController() {
        super();
    }

    @Override
    public boolean refreshRegion(RegionContext regionContext) {
        int refreshFlag = regionContext.getRefreshFlag();
        //.
        if (refreshFlag == RegionBinding.PREPARE_MODEL) {
            this.initializeMethod();
        }
        //regionContext.getRegionBinding().refresh(refreshFlag);
        return false;
    }

    @Override
    public boolean validateRegion(RegionContext regionContext) {
       // regionContext.getRegionBinding().validate();
        return false;
    }

    @Override
    public boolean isRegionViewable(RegionContext regionContext) {
        // TODO Implement this method
        return false;
    }

    @Override
    public String getName() {
        // TODO Implement this method
        return null;
    }
    
    public void initializeMethod() {

        RowSetIterator iterator =
            ((DCBindingContainer) BindingContext.getCurrent().getCurrentBindingsEntry()).findIteratorBinding("DritinView2Iterator").getViewObject().createRowSetIterator(null);
        Row row = null;
        iterator.reset();
        String jsArray = "[";
        String ligne = "";
        
       
        while (iterator.hasNext()) {
            row = iterator.next();
            if ((row.getAttribute("StopLat") != null) && (row.getAttribute("StopLon") != null))
                jsArray +=
                    "{\"t\": \"" + row.getAttribute("Delstaa") + "\"," +  "\"l\": " +
                    row.getAttribute("StopLat") + "," + "\"g\": " + row.getAttribute("StopLon") + "},";
            ligne = (String) row.getAttribute("Denumli");
        }
        iterator.closeRowSetIterator();
        jsArray += "]";


        jsArray = jsArray.replace("},]", "}]");
       // System.out.println("initializeMethod :" +jsArray);
        // call javascript function with param


        //String language = JsfUtils.resolveExpression("#{pageFlowScope.language}").toString();
        FacesContext fctx = FacesContext.getCurrentInstance();
        ExtendedRenderKitService erks = Service.getRenderKitService(fctx, ExtendedRenderKitService.class);
        //erks.addScript(fctx, "initialize('"+ "fgf" +"');");
        //System.out.print("hello :" + ligne);


       // erks.addScript(fctx, "initialize('" + jsArray + "','" + ligne + "')");
        erks.addScript(fctx, "initialize('" + jsArray + "','" + ligne +  "')");
       
        
        
    }


    public BindingContainer getBindings() {
        return BindingContext.getCurrent().getCurrentBindingsEntry();
    }
}
